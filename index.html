<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="theme-color" content="#000000">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="Windsurf Model Selector v6.0">
    <meta property="og:description" content="Smart prompt enhancement for Windsurf IDE - Analyze your task, get optimal model recommendations, and enhance your prompts with AI">
    <meta property="og:type" content="website">
    <meta name="twitter:card" content="summary_large_image">
    
    <title>Windsurf Model Selector v6.0 - Smart Prompt Enhancement</title>
    
    <style>
        /* ========================================
           DESIGN SYSTEM - DARK MODE (AMOLED)
           Samsung S22 Optimized
        ======================================== */
        
        :root {
            /* AMOLED True Black for Samsung S22 */
            --bg-body: #000000;
            --bg-card: #0a0a0a;
            --bg-elevated: #141414;
            --bg-hover: #1a1a1a;
            --bg-input: #0f0f0f;
            
            /* Text Colors */
            --text-primary: #f5f5f5;
            --text-secondary: #a3a3a3;
            --text-muted: #737373;
            
            /* Primary Accent */
            --primary: #3b82f6;
            --primary-hover: #2563eb;
            --primary-light: rgba(59, 130, 246, 0.1);
            --primary-glow: rgba(59, 130, 246, 0.3);
            
            /* Status Colors */
            --success: #10b981;
            --success-light: rgba(16, 185, 129, 0.1);
            --warning: #f59e0b;
            --warning-light: rgba(245, 158, 11, 0.1);
            --error: #ef4444;
            --error-light: rgba(239, 68, 68, 0.1);
            --info: #06b6d4;
            --info-light: rgba(6, 182, 212, 0.1);
            
            /* Model Category Colors */
            --workhorse: #8b5cf6;
            --premium: #f59e0b;
            --budget: #10b981;
            --free: #6b7280;
            --planning: #ec4899;
            --avoid: #ef4444;
            --speed: #06b6d4;
            --balanced: #3b82f6;
            
            /* Borders */
            --border: rgba(255, 255, 255, 0.08);
            --border-hover: rgba(255, 255, 255, 0.15);
            --border-focus: rgba(59, 130, 246, 0.5);
            
            /* Spacing - Compacted */
            --space-1: 4px;
            --space-2: 8px;
            --space-3: 12px;
            --space-4: 16px;
            --space-5: 20px;
            --space-6: 24px;
            --space-8: 32px;
            
            /* Border Radius */
            --radius-sm: 4px;
            --radius-md: 6px;
            --radius-lg: 8px;
            --radius-xl: 12px;
            --radius-full: 9999px;
            
            /* Transitions */
            --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-base: 200ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 300ms cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* ========================================
           RESET & BASE STYLES
        ======================================== */
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html {
            font-size: 14px; /* Reduced base font size */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-body);
            color: var(--text-primary);
            line-height: 1.5;
            padding: var(--space-4);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* ========================================
           TYPOGRAPHY - Compacted
        ======================================== */
        
        h1 {
            font-size: 1.75rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary) 0%, var(--info) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: var(--space-2);
            letter-spacing: -0.02em;
        }
        
        h2 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--space-3);
        }
        
        h3 {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--space-3);
        }
        
        p {
            color: var(--text-secondary);
            margin-bottom: var(--space-3);
            font-size: 0.95rem;
        }
        
        /* ========================================
           LAYOUT
        ======================================== */
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }
        
        .grid {
            display: grid;
            gap: var(--space-4);
        }
        
        .grid-2 {
            grid-template-columns: 1fr 320px;
            align-items: start;
        }
        
        /* ========================================
           HEADER
        ======================================== */
        
        header {
            text-align: center;
            margin-bottom: var(--space-6);
            padding: var(--space-4) 0;
        }
        
        .subtitle {
            font-size: 0.95rem;
            color: var(--text-secondary);
            margin-bottom: var(--space-3);
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }
        
        /* ========================================
           TABS
        ======================================== */
        
        .tabs {
            display: flex;
            gap: var(--space-2);
            margin-bottom: var(--space-4);
            border-bottom: 1px solid var(--border);
            padding-bottom: var(--space-2);
        }
        
        .tab-btn {
            padding: var(--space-2) var(--space-4);
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--text-secondary);
            transition: all var(--transition-base);
            border-bottom: 2px solid transparent;
            position: relative;
            white-space: nowrap;
            border-radius: var(--radius-sm) var(--radius-sm) 0 0;
        }
        
        .tab-btn:hover {
            color: var(--text-primary);
            background: var(--bg-hover);
        }
        
        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            background: var(--bg-card);
        }
        
        .tab-btn .badge {
            display: inline-block;
            margin-left: var(--space-2);
            padding: 2px 6px;
            background: var(--primary-light);
            color: var(--primary);
            border-radius: var(--radius-full);
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn var(--transition-base);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* ========================================
           COMPONENTS
        ======================================== */
        
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            transition: all var(--transition-base);
        }
        
        .auto-mode-section {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--bg-elevated);
            padding: var(--space-3) var(--space-4);
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
            margin-bottom: var(--space-4);
        }
        
        .auto-mode-title {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.95rem;
            margin-bottom: 2px;
        }
        
        .auto-mode-desc {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        
        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-hover);
            transition: .4s;
            border-radius: 24px;
            border: 1px solid var(--border);
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 2px;
            bottom: 2px;
            background-color: var(--text-secondary);
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: var(--primary-light);
            border-color: var(--primary);
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(20px);
            background-color: var(--primary);
        }
        
        /* ========================================
           PRESETS - Compact Grid
        ======================================== */
        
        .presets-section h3 {
            font-size: 1rem;
            margin-bottom: var(--space-2);
        }
        
        .presets-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: var(--space-2);
            margin-bottom: var(--space-4);
        }
        
        .preset-btn {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: var(--space-3);
            cursor: pointer;
            transition: all var(--transition-fast);
            text-align: left;
            min-height: auto;
            display: flex;
            flex-direction: column;
            gap: var(--space-1);
        }
        
        .preset-btn:hover {
            border-color: var(--primary);
            background: var(--bg-hover);
            transform: translateY(-1px);
        }
        
        .preset-btn.active {
            background: var(--primary-light);
            border-color: var(--primary);
        }
        
        .preset-icon {
            font-size: 1.25rem;
            margin-bottom: var(--space-1);
        }
        
        .preset-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.85rem;
        }
        
        .preset-desc {
            font-size: 0.75rem;
            color: var(--text-secondary);
            line-height: 1.3;
        }
        
        /* ========================================
           INPUT & BUTTONS
        ======================================== */
        
        .input-section {
            margin-bottom: var(--space-4);
        }
        
        .input-label {
            display: block;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: var(--space-2);
            font-size: 0.9rem;
        }
        
        textarea {
            width: 100%;
            min-height: 120px;
            padding: var(--space-3);
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.95rem;
            resize: vertical;
            transition: border-color var(--transition-fast);
        }
        
        textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 1px var(--primary-glow);
        }
        
        .input-hint {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: var(--space-2);
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
            padding: var(--space-3) var(--space-4);
            border-radius: var(--radius-md);
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all var(--transition-base);
            border: 1px solid transparent;
            line-height: 1;
        }
        
        .btn-full {
            width: 100%;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        
        .btn-primary:hover {
            background: var(--primary-hover);
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background: var(--bg-elevated);
            color: var(--text-primary);
            border-color: var(--border);
        }
        
        .btn-secondary:hover {
            padding: var(--space-3);
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        /* ========================================
           SIDEBAR RECOMMENDATIONS (RE-OVERHAULED)
        ======================================== */
        
        .recommendations-sidebar {
            background: var(--bg-elevated);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            padding: var(--space-4);
            height: fit-content;
            position: sticky;
            top: var(--space-4);
        }
        
        .sidebar-title {
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: var(--space-3);
            padding-bottom: var(--space-2);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }
        
        #compact-cards {
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
        }
        
        .compact-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: var(--space-3);
            transition: all var(--transition-fast);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .compact-card:hover {
            border-color: var(--primary);
            background: var(--bg-hover);
            transform: translateX(2px);
        }
        
        .compact-header {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            margin-bottom: var(--space-2);
        }
        
        .compact-rank {
            font-size: 1rem;
            font-weight: 800;
            color: var(--text-muted);
            background: var(--bg-elevated);
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
        }
        
        .compact-rank.rank-1 { color: var(--success); border-color: var(--success); background: rgba(16, 185, 129, 0.1); }
        .compact-rank.rank-2 { color: var(--primary); border-color: var(--primary); background: rgba(59, 130, 246, 0.1); }
        .compact-rank.rank-3 { color: var(--warning); border-color: var(--warning); background: rgba(245, 158, 11, 0.1); }
        
        .compact-title {
            flex: 1;
            display: flex;
            flex-direction: column;
            line-height: 1.2;
        }
        
        .compact-name {
            font-weight: 700;
            font-size: 0.9rem;
            color: var(--text-primary);
        }
        
        .compact-provider {
            font-size: 0.7rem;
            color: var(--text-muted);
        }
        
        .compact-metrics-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--bg-elevated);
            padding: 4px 8px;
            border-radius: var(--radius-sm);
            margin-bottom: var(--space-2);
            border: 1px solid var(--border);
        }
        
        .c-metric {
            font-size: 0.75rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 4px;
            font-weight: 500;
        }
        
        .c-metric span {
            color: var(--text-primary);
            font-weight: 700;
        }
        
        .compact-footer {
            font-size: 0.7rem;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding-top: 4px;
            border-top: 1px solid var(--border);
        }

        /* ========================================
           ANALYSIS BREAKDOWN (SHADCN STYLE)
        ======================================== */

        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-3);
            margin-bottom: var(--space-5);
        }

        .analysis-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: var(--space-4);
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
            transition: all var(--transition-fast);
        }

        .analysis-card:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            transform: translateY(-2px);
        }

        .analysis-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 0.85rem;
            color: var(--text-muted);
            font-weight: 500;
        }

        .analysis-icon {
            font-size: 1.1rem;
            opacity: 0.8;
        }

        .analysis-value-large {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1.2;
            letter-spacing: -0.02em;
        }

        .analysis-subtext {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .analysis-progress-bg {
            height: 6px;
            background: var(--bg-elevated);
            border-radius: 999px;
            overflow: hidden;
            margin-top: var(--space-2);
            border: 1px solid var(--border);
        }

        .analysis-progress-fill {
            height: 100%;
            background: var(--primary);
            border-radius: 999px;
            transition: width 1s ease-out;
        }

        .analysis-badge {
            display: inline-flex;
            align-items: center;
            padding: 2px 10px;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 600;
            background: var(--bg-elevated);
            color: var(--text-secondary);
            border: 1px solid transparent;
        }

        .badge-critical { background: rgba(239, 68, 68, 0.1); color: #ef4444; border-color: rgba(239, 68, 68, 0.2); }
        .badge-high { background: rgba(245, 158, 11, 0.1); color: #f59e0b; border-color: rgba(245, 158, 11, 0.2); }
        .badge-normal { background: rgba(59, 130, 246, 0.1); color: #3b82f6; border-color: rgba(59, 130, 246, 0.2); }
        .badge-low { background: rgba(16, 185, 129, 0.1); color: #10b981; border-color: rgba(16, 185, 129, 0.2); }

        /* ========================================
           ACCORDION
        ======================================== */
        
        .accordion-toggle {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-3);
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .accordion-toggle:hover {
            background: var(--bg-hover);
        }
        
        .accordion-toggle.active {
            border-color: var(--primary);
            background: var(--primary-light);
            color: var(--primary);
        }
        
        .accordion-toggle .toggle-icon {
            transition: transform var(--transition-fast);
        }

        .accordion-toggle.active .toggle-icon {
            transform: rotate(180deg);
        }

        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: all 0.3s ease-out;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-top: none;
            border-radius: 0 0 var(--radius-md) var(--radius-md);
            opacity: 0;
            display: none;
        }

        .accordion-content.show {
            max-height: 500px;
            opacity: 1;
            padding: var(--space-3);
            overflow-y: auto;
            display: block;
        }
        
        .prompt-diff h4 {
            font-size: 0.8rem;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: var(--space-2);
        }
        
        .original-prompt p, .enhanced-prompt p {
            font-size: 0.85rem;
            line-height: 1.4;
            padding: var(--space-2);
            background: var(--bg-body);
            border-radius: var(--radius-sm);
            margin-bottom: var(--space-3);
        }
        
        .enhanced-prompt mark {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success);
            padding: 0 2px;
            border-radius: 2px;
        }
        
        .identified-gaps {
            margin-bottom: var(--space-4);
        }
        
        .identified-gaps h4 {
            font-size: 0.85rem;
            margin-bottom: var(--space-2);
        }
        
        #gaps-list {
            list-style: none;
        }
        
        #gaps-list li {
            font-size: 0.8rem;
            color: var(--warning);
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        #gaps-list li:before {
            content: "‚ö†Ô∏è";
            font-size: 0.8rem;
        }
        
        .enhancement-actions {
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
        }
        
        .enhancement-actions .btn {
            padding: var(--space-2);
            font-size: 0.85rem;
        }
        
        .hidden { display: none !important; }
        
        /* ========================================
           MANUAL CONTROL (TRIANGLE)
        ======================================== */
        
        .manual-control {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: var(--space-4);
            margin-bottom: var(--space-4);
            text-align: center;
        }
        
        .triangle-container {
            position: relative;
            width: 100%;
            height: 320px;
            display: flex;
            justify-content: center;
            align-items: center;
            background: var(--bg-card);
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
            margin: var(--space-3) 0;
            overflow: hidden;
        }

        .triangle-canvas {
            width: 100%;
            height: 100%;
            cursor: crosshair;
            touch-action: none; /* Prevent browser handling of gestures */
        }
        
        .triangle-legend {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--space-2);
            margin-top: var(--space-3);
        }
        
        .legend-item {
            padding: var(--space-2);
            border-radius: var(--radius-sm);
            text-align: center;
            font-size: 0.8rem;
            border: 1px solid;
            background: var(--bg-card);
        }
        
        .legend-item strong {
            display: block;
            margin-bottom: 2px;
            font-size: 0.85rem;
        }
        
        .legend-item span {
            display: block;
            font-size: 0.7rem;
            opacity: 0.8;
        }
        
        .legend-item.quality {
            border-color: rgba(239, 68, 68, 0.3);
            color: var(--error);
        }
        
        .legend-item.speed {
            border-color: rgba(16, 185, 129, 0.3);
            color: var(--success);
        }
        
        .legend-item.balanced {
            border-color: rgba(59, 130, 246, 0.3);
            color: var(--primary);
        }
        
        /* ========================================
           RESULTS & MODEL CARDS (REFINED)
        ======================================== */
        
        .results-section {
            margin-top: var(--space-4);
        }
        
        .model-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: var(--space-4);
            margin-bottom: var(--space-3);
            position: relative;
            overflow: hidden;
            border-left: 3px solid var(--border);
            display: grid;
            gap: var(--space-3);
        }
        
        .model-card:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            transform: translateY(-1px);
        }
        
        .model-card.rank-1 { border-left-color: var(--success); background: linear-gradient(to right, rgba(16, 185, 129, 0.05), transparent); }
        .model-card.rank-2 { border-left-color: var(--primary); }
        .model-card.rank-3 { border-left-color: var(--warning); }
        
        .model-header-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        
        .model-title-group {
            display: flex;
            flex-direction: column;
        }
        
        .model-name {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1.2;
        }
        
        .model-provider {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 2px;
        }
        
        .model-badges {
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }
        
        .rank-badge {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            padding: 2px 8px;
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--text-secondary);
        }
        
        .rank-badge.rank-1 { color: var(--success); border-color: var(--success); background: var(--success-light); }
        .rank-badge.rank-2 { color: var(--primary); border-color: var(--primary); background: var(--primary-light); }
        
        .model-metrics-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1px;
            background: var(--border);
            border-radius: var(--radius-sm);
            overflow: hidden;
            border: 1px solid var(--border);
        }
        
        .metric-item {
            background: var(--bg-elevated);
            padding: 6px 4px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .metric-item strong {
            font-size: 0.9rem;
            color: var(--text-primary);
            line-height: 1;
            margin-bottom: 2px;
        }
        
        .metric-item span {
            font-size: 0.65rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }
        
        .model-details-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: var(--space-2);
            font-size: 0.85rem;
        }
        
        .detail-row {
            display: flex;
            gap: var(--space-2);
            align-items: baseline;
        }
        
        .detail-label {
            color: var(--text-muted);
            font-size: 0.75rem;
            min-width: 60px;
            flex-shrink: 0;
        }
        
        .detail-content {
            color: var(--text-secondary);
            flex: 1;
        }
        
        .pill {
            display: inline-block;
            padding: 1px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            background: var(--bg-hover);
            color: var(--text-secondary);
            margin-right: 4px;
            margin-bottom: 2px;
        }
        .pill.good { color: var(--success); background: rgba(16, 185, 129, 0.1); }
        .pill.bad { color: var(--error); background: rgba(239, 68, 68, 0.1); }
        
        .model-description-text {
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.4;
            padding-top: var(--space-2);
            border-top: 1px solid var(--border);
        }
        
        /* ========================================
           MODALS & OVERLAYS (NEW)
        ======================================== */
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity var(--transition-base);
        }
        
        .modal-overlay.active {
            opacity: 1;
            pointer-events: all;
        }
        
        .modal {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            width: 90%;
            max-width: 600px;
            max-height: 85vh;
            overflow-y: auto;
            transform: translateY(20px);
            transition: transform var(--transition-base);
            display: flex;
            flex-direction: column;
        }
        
        .modal-overlay.active .modal {
            transform: translateY(0);
        }
        
        .modal-header {
            padding: var(--space-4);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: var(--bg-card);
            z-index: 10;
        }
        
        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .modal-close {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            padding: var(--space-2);
            line-height: 1;
        }
        
        .modal-body {
            padding: var(--space-4);
        }
        
        /* History Items */
        .history-item {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: var(--space-3);
            margin-bottom: var(--space-3);
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .history-item:hover {
            border-color: var(--primary);
        }
        
        .history-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: var(--space-2);
            font-size: 0.85rem;
            color: var(--text-muted);
        }
        
        /* Calculator Grid */
        .calc-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-3);
            margin-bottom: var(--space-4);
        }
        
        .calc-result {
            background: var(--bg-elevated);
            padding: var(--space-4);
            border-radius: var(--radius-md);
            text-align: center;
            margin-top: var(--space-4);
            border: 1px solid var(--border);
        }
        
        .calc-total {
            font-size: 2rem;
            font-weight: 700;
            color: var(--success);
            display: block;
            margin: var(--space-2) 0;
        }
        
        /* Shortcut Keys */
        .key-combo {
            display: inline-flex;
            gap: 4px;
        }
        
        .kbd {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 2px 6px;
            font-family: monospace;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        /* Toolbar */
        .toolbar {
            display: flex;
            gap: var(--space-2);
            margin-bottom: var(--space-4);
            flex-wrap: wrap;
        }

        .tool-btn {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 6px 12px;
            border-radius: var(--radius-md);
            font-size: 0.85rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all var(--transition-fast);
        }

        .tool-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        /* ========================================
           RESPONSIVE DESIGN
        ======================================== */
        
        @media (max-width: 900px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }
            
            .recommendations-sidebar {
                position: static;
                margin-top: var(--space-6);
            }
        }
        
        @media (max-width: 600px) {
            h1 { font-size: 1.5rem; }
            .model-metrics { grid-template-columns: repeat(2, 1fr); }
            .presets-grid { grid-template-columns: repeat(2, 1fr); }
            .analysis-grid { grid-template-columns: repeat(2, 1fr); }
        }
        
        .budget-circle-bg {
            fill: none;
            stroke: var(--bg-hover);
            stroke-width: 10;
        }
        
        .budget-circle-fill {
            fill: none;
            stroke: var(--primary);
            stroke-width: 10;
            stroke-linecap: round;
            transition: stroke-dashoffset var(--transition-slow);
        }
        
        .budget-circle-fill.warning {
            stroke: var(--warning);
        }
        
        .budget-circle-fill.critical {
            stroke: var(--error);
        }
        
        .budget-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }
        
        .budget-percent {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        
        .budget-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }
        
        .budget-stats {
            display: grid;
            gap: var(--space-3);
            margin-bottom: var(--space-4);
        }
        
        .budget-stat {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-3);
            background: var(--bg-elevated);
            border-radius: var(--radius-md);
        }
        
        .budget-stat-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        
        .budget-stat-value {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .budget-actions {
            margin-top: var(--space-4);
            display: grid;
            gap: var(--space-2);
        }
        
        /* ========================================
           TOAST NOTIFICATIONS
        ======================================== */
        
        .toast-container {
            position: fixed;
            bottom: var(--space-4);
            right: var(--space-4);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
            max-width: 400px;
        }
        
        .toast {
            padding: var(--space-4);
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: flex-start;
            gap: var(--space-3);
            animation: slideIn var(--transition-base);
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .toast-icon {
            font-size: 1.25rem;
            flex-shrink: 0;
        }
        
        .toast-content {
            flex: 1;
        }
        
        .toast-title {
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: var(--space-1);
        }
        
        .toast-message {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        
        .toast.success {
            border-left: 4px solid var(--success);
        }
        
        .toast.warning {
            border-left: 4px solid var(--warning);
        }
        
        .toast.error {
            border-left: 4px solid var(--error);
        }
        
        /* ========================================
           RESPONSIVE DESIGN
        ======================================== */
        
        @media (max-width: 768px) {
            body {
                padding: var(--space-3);
            }
            
            h1 {
                font-size: 2rem;
            }
            
            h2 {
                font-size: 1.25rem;
            }
            
            .presets-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }
            
            .preset-btn {
                min-height: 80px;
                padding: var(--space-3);
            }
            
            .preset-icon {
                font-size: 1.5rem;
            }
            
            .model-metrics {
                grid-template-columns: 1fr 1fr;
            }
        }
        
        @media (max-width: 480px) {
            .tabs {
                flex-direction: column;
            }
            
            .tab-btn {
                width: 100%;
                text-align: left;
            }
            
            .presets-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header role="banner">
            <h1>üß† Windsurf Model Selector</h1>
            <p class="subtitle">Analyze your task, get optimal model recommendations, and enhance your prompts with AI</p>
        </header>

        <!-- Main Content -->
        <main role="main">
            <!-- Tabs -->
            <div class="tabs" role="tablist">
                <button class="tab-btn active" role="tab" aria-selected="true" aria-controls="windsurf-tab" id="windsurf-tab-btn" onclick="switchTab('windsurf')">
                    Windsurf <span class="badge">16 models</span>
                </button>
            </div>

            <div class="grid grid-2">
                <!-- Left Column: Main Content -->
                <div>
                    <!-- Windsurf Tab -->
                    <div id="windsurf-tab" class="tab-content active" role="tabpanel" aria-labelledby="windsurf-tab-btn">
                        <!-- Auto Mode Toggle -->
                        <div class="auto-mode-section">
                            <div class="auto-mode-info">
                                <div class="auto-mode-title">ü§ñ Auto-Detect Mode</div>
                                <div class="auto-mode-desc">Automatically analyze your task and recommend optimal models</div>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="auto-mode-windsurf" checked onchange="toggleAutoMode('windsurf')" aria-label="Toggle auto-detect mode">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>

                        <!-- Toolbar -->
                        <div class="toolbar">
                            <button class="tool-btn" onclick="showHistory()" title="View Analysis History (Ctrl+H)">
                                <span>üìú History</span>
                            </button>
                            <button class="tool-btn" onclick="showCalculator()" title="Budget Calculator (Ctrl+B)">
                                <span>üí∞ Calculator</span>
                            </button>
                            <button class="tool-btn" onclick="showSettings()" title="Settings & Custom Models (Ctrl+,)">
                                <span>‚öôÔ∏è Settings</span>
                            </button>
                            <button class="tool-btn" onclick="showShortcuts()" title="Keyboard Shortcuts (?)">
                                <span>‚å®Ô∏è Shortcuts</span>
                            </button>
                        </div>

                        <!-- Presets -->
                        <div class="presets-section">
                            <h3>Quick Presets</h3>
                            <div class="presets-grid" id="presets-windsurf">
                                <!-- Presets will be dynamically generated -->
                            </div>
                        </div>

                        <!-- Manual Control (Triangle) -->
                        <div id="manual-control-windsurf" class="manual-control hidden">
                            <h3>Manual Preference Control</h3>
                            <p class="input-hint">Drag the dot to set your preferences. Use arrow keys for precise control. Double-tap to reset.</p>
                            <div class="triangle-container">
                                <canvas id="triangle-canvas-windsurf" class="triangle-canvas" tabindex="0" role="img" aria-label="Triangle selector for model preferences"></canvas>
                            </div>
                            <div class="triangle-legend">
                                <div class="legend-item quality">
                                    <strong>Quality</strong>
                                    <span>Best results, slower</span>
                                </div>
                                <div class="legend-item speed">
                                    <strong>Speed/Cost</strong>
                                    <span>Fast, economical</span>
                                </div>
                                <div class="legend-item balanced">
                                    <strong>Balanced</strong>
                                    <span>Mix of both</span>
                                </div>
                            </div>
                            <div class="triangle-controls">
                                <button class="btn btn-secondary" onclick="resetTriangle('windsurf')">Reset to Center</button>
                            </div>
                        </div>

                        <!-- Input Section -->
                        <div class="input-section">
                            <label for="windsurf-input" class="input-label">Describe Your Task</label>
                            <textarea 
                                id="windsurf-input" 
                                placeholder="Example: 'Refactor authentication system with 10 files' or 'Quick fix in Header.jsx' or 'Plan microservices architecture'"
                                aria-describedby="windsurf-input-hint"
                            ></textarea>
                            <p id="windsurf-input-hint" class="input-hint">
                                üí° Tip: Mention complexity, urgency, budget constraints, or specific files for better recommendations
                            </p>
                        </div>

                        <!-- Analyze Button -->
                        <button class="btn btn-primary btn-full" onclick="analyzeWindsurf()">
                            <span>‚ú® Analyze & Get Recommendations</span>
                        </button>

                        <!-- Results -->
                        <div id="windsurf-results" class="results-section hidden" role="region" aria-live="polite">
                            <!-- Results will be dynamically generated -->
                        </div>
                    </div>

                </div>

                <!-- Right Column: Prompt Enhancement Sidebar -->
                <aside class="recommendations-sidebar" role="complementary">
                    <div id="compact-recommendations" class="hidden">
                        <h3 class="sidebar-title">üéØ Top 3 Models</h3>
                        <div id="compact-cards"></div>
                    </div>
                    <div id="prompt-enhancement" class="hidden">
                        <h3 class="sidebar-title">‚ú® Prompt Enhancements</h3>
                        <div class="prompt-comparison">
                            <button class="accordion-toggle" onclick="togglePromptComparison()">
                                <span>View Enhanced Prompt</span>
                                <span class="toggle-icon">‚ñº</span>
                            </button>
                            <div class="accordion-content hidden">
                                <div class="prompt-diff">
                                    <div class="original-prompt">
                                        <h4>Original</h4>
                                        <p id="original-text"></p>
                                    </div>
                                    <div class="enhanced-prompt">
                                        <h4>Enhanced</h4>
                                        <p id="enhanced-text"></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="identified-gaps">
                            <h4>Identified Gaps</h4>
                            <ul id="gaps-list"></ul>
                        </div>
                        <div class="enhancement-actions">
                            <button class="btn btn-primary btn-full" onclick="copyEnhancedPrompt()">üìã Copy Enhanced Prompt</button>
                            <button class="btn btn-secondary btn-full" onclick="refineAgain()">üîÑ Refine Again</button>
                            <button class="btn btn-secondary btn-full" onclick="viewFullAnalysis()">üìä View Full Analysis</button>
                            <button class="btn btn-secondary btn-full" onclick="saveToHistory()">üíæ Save to History</button>
                        </div>
                    </div>
                </aside>
            </div>
        </main>
    </div>

    <!-- History Modal -->
    <div id="history-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">üìú Analysis History</div>
                <button class="modal-close" onclick="closeModal('history-modal')">√ó</button>
            </div>
            <div class="modal-body" id="history-list">
                <!-- History items will be injected here -->
                <p class="text-muted text-center" style="text-align: center; color: var(--text-muted);">No history yet.</p>
            </div>
        </div>
    </div>

    <!-- Calculator Modal -->
    <div id="calculator-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">üí∞ Budget Calculator</div>
                <button class="modal-close" onclick="closeModal('calculator-modal')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="input-section">
                    <label class="input-label">Daily Coding Hours</label>
                    <input type="range" id="calc-hours" min="1" max="12" value="4" oninput="calculateBudget()" style="width: 100%;">
                    <div style="display: flex; justify-content: space-between; font-size: 0.8rem; color: var(--text-muted); margin-top: 4px;">
                        <span>1h</span>
                        <span id="calc-hours-val">4h</span>
                        <span>12h</span>
                    </div>
                </div>
                
                <div class="input-section">
                    <label class="input-label">Task Complexity (Avg)</label>
                    <input type="range" id="calc-complexity" min="1" max="10" value="5" oninput="calculateBudget()" style="width: 100%;">
                    <div style="display: flex; justify-content: space-between; font-size: 0.8rem; color: var(--text-muted); margin-top: 4px;">
                        <span>Simple</span>
                        <span id="calc-complexity-val">Medium</span>
                        <span>Complex</span>
                    </div>
                </div>

                <div class="calc-result">
                    <div style="font-size: 0.9rem; color: var(--text-muted);">Estimated Monthly Cost</div>
                    <span class="calc-total" id="calc-total">$0.00</span>
                    <div style="font-size: 0.8rem; color: var(--text-muted);" id="calc-breakdown">Based on standard model usage mix</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">‚öôÔ∏è Settings</div>
                <button class="modal-close" onclick="closeModal('settings-modal')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="settings-section">
                    <h3>Custom Models</h3>
                    <div class="input-section">
                        <textarea id="custom-model-json" placeholder='{"my-model": {"name": "My Model", "cost": 0.5, ...}}'></textarea>
                        <p class="input-hint">Paste JSON definition for custom models</p>
                    </div>
                    <button class="btn btn-primary btn-full" onclick="saveCustomModels()">Save Custom Models</button>
                </div>
                
                <div class="settings-section" style="margin-top: 2rem;">
                    <h3>Data Management</h3>
                    <div class="grid grid-2" style="margin-bottom: 1rem;">
                        <button class="btn btn-secondary" onclick="exportData()">üì§ Export Data</button>
                        <button class="btn btn-secondary" onclick="importData()">üì• Import Data</button>
                    </div>
                    <button class="btn btn-secondary btn-full" style="color: var(--error); border-color: var(--error);" onclick="clearAllData()">üóëÔ∏è Reset All Data</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Shortcuts Modal -->
    <div id="shortcuts-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">‚å®Ô∏è Keyboard Shortcuts</div>
                <button class="modal-close" onclick="closeModal('shortcuts-modal')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="shortcuts-list">
                    <div class="history-item">
                        <div class="history-header">
                            <span>Analyze Task</span>
                            <span class="key-combo"><span class="kbd">Ctrl</span> + <span class="kbd">Enter</span></span>
                        </div>
                    </div>
                    <div class="history-item">
                        <div class="history-header">
                            <span>Clear Input</span>
                            <span class="key-combo"><span class="kbd">Esc</span></span>
                        </div>
                    </div>
                    <div class="history-item">
                        <div class="history-header">
                            <span>Show History</span>
                            <span class="key-combo"><span class="kbd">Ctrl</span> + <span class="kbd">H</span></span>
                        </div>
                    </div>
                    <div class="history-item">
                        <div class="history-header">
                            <span>Budget Calculator</span>
                            <span class="key-combo"><span class="kbd">Ctrl</span> + <span class="kbd">B</span></span>
                        </div>
                    </div>
                    <div class="history-item">
                        <div class="history-header">
                            <span>Settings</span>
                            <span class="key-combo"><span class="kbd">Ctrl</span> + <span class="kbd">,</span></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="toast-container" role="status" aria-live="polite"></div>

    <script>
        // ========================================
        // MODEL DATABASE - December 2025 Accurate Data
        // ========================================
        
        const WINDSURF_MODELS = {
            // IN-HOUSE MODELS
            'swe-1.5': {
                name: 'SWE-1.5',
                provider: 'Windsurf',
                cost: 0.5,
                speed: 9,
                quality: 8.5,
                context: '16K',
                bestFor: 'Execution, backend/frontend work, refactoring',
                avoid: 'Complex architectural planning',
                category: 'workhorse',
                promo: true,
                promoNote: 'Limited time promo pricing',
                communityRating: 9.5,
                description: 'Near Claude 4.5-level performance at 13x the speed. Best bang for buck. Use 80% of the time.'
            },
            'swe-1.5-mini': {
                name: 'SWE-1.5-mini',
                provider: 'Windsurf',
                cost: 0.25,
                speed: 8,
                quality: 6.5,
                context: '16K',
                bestFor: 'Trivial fixes, tests, simple completions',
                avoid: 'Complex logic, debugging',
                category: 'budget',
                communityRating: 8.0,
                description: 'Fast and economical for simple tasks. Perfect for quick edits and trivial fixes.'
            },
            'swe-1': {
                name: 'SWE-1',
                provider: 'Windsurf',
                cost: 1.0,
                speed: 7,
                quality: 7.5,
                context: '16K',
                bestFor: 'Full software engineering lifecycle',
                avoid: 'When SWE-1.5 is available',
                category: 'balanced',
                communityRating: 7.5,
                description: 'Claude 3.5-level performance at a fraction of the cost. Solid choice when SWE-1.5 is unavailable.'
            },
            
            // ANTHROPIC MODELS
            'claude-4.5': {
                name: 'Claude Sonnet 4.5',
                provider: 'Anthropic',
                cost: 2.0,
                speed: 5,
                quality: 9.5,
                context: '1M',
                bestFor: 'Complex debugging, legacy code, architectural review',
                avoid: 'Simple tasks, speed-critical work',
                category: 'premium',
                communityRating: 9.0,
                description: 'Most capable model in Windsurf. 1M token context window. Significantly better for debugging. Use 4% of the time.',
                contextWindow: '1M tokens (new!)'
            },
            'claude-3.7': {
                name: 'Claude Sonnet 3.7',
                provider: 'Anthropic',
                cost: 1.0,
                speed: 6,
                quality: 8.0,
                context: '200K',
                bestFor: 'Planning, general coding, test writing',
                avoid: 'Very deep architectural planning',
                category: 'balanced',
                communityRating: 8.5,
                description: 'Balanced champion for general purpose coding. Good when SWE-1.5 struggles. Use 15% of the time.'
            },
            'claude-3.7-thinking': {
                name: 'Claude 3.7 Thinking',
                provider: 'Anthropic',
                cost: 1.5,
                speed: 2,
                quality: 9.5,
                context: '200K',
                bestFor: 'Architecture planning (PLANNING ONLY)',
                avoid: 'Execution phase, simple tasks',
                category: 'planning',
                warning: '3x token usage - use sparingly!',
                tokenMultiplier: 3,
                communityRating: 8.0,
                description: 'Use only for one-time architecture per project. One planning prompt = 6% of monthly budget.'
            },
            'claude-4-opus': {
                name: 'Claude Opus 4.5',
                provider: 'Anthropic',
                cost: 2.0,
                speed: 3,
                quality: 10,
                context: '200K',
                bestFor: 'Maximum reasoning, most complex tasks',
                avoid: 'Budget-conscious workflows',
                category: 'premium',
                promo: true,
                promoNote: 'Limited time: Sonnet pricing for Opus!',
                communityRating: 9.5,
                description: 'Maximum reasoning capability. Available at Sonnet pricing for limited time.'
            },
            
            // OPENAI MODELS
            'gpt-5.2': {
                name: 'GPT-5.2',
                provider: 'OpenAI',
                cost: 0.0,
                speed: 7,
                quality: 8.5,
                context: '128K',
                bestFor: 'State-of-the-art coding (FREE)',
                avoid: 'Production critical work (promo may end)',
                category: 'free',
                promo: true,
                promoNote: '0x credits temporarily for paid users!',
                communityRating: 8.0,
                description: 'State-of-the-art coding with 0x credits temporarily. Act fast before promo ends.'
            },
            'gpt-5.1-medium': {
                name: 'GPT-5.1 (Medium Reasoning)',
                provider: 'OpenAI',
                cost: 2.5,
                speed: 3,
                quality: 8.5,
                context: '128K',
                bestFor: 'Project understanding, architecture scope',
                avoid: 'Execution phase - gets stuck in loops',
                category: 'premium',
                warning: 'May get stuck in analysis loops',
                communityRating: 7.0,
                description: 'Better at project understanding but SLOW. Gets stuck in loops with Cascade.'
            },
            'gpt-5.1-low': {
                name: 'GPT-5.1 (Low Reasoning)',
                provider: 'OpenAI',
                cost: 1.5,
                speed: 6,
                quality: 7.0,
                context: '128K',
                bestFor: 'Medium-complexity coding, scoped problems',
                avoid: 'Trivial tasks',
                category: 'balanced',
                communityRating: 7.5,
                description: 'Medium complexity coding with decent quality. Better than GPT-4, worse than Claude.'
            },
            'gpt-5.1-codex': {
                name: 'GPT-5.1-Codex',
                provider: 'OpenAI',
                cost: 2.0,
                speed: 2,
                quality: 6.0,
                context: '128K',
                bestFor: 'AVOID - Infinite loops',
                avoid: 'EVERYTHING - Community consensus',
                category: 'avoid',
                warning: 'AVOID ENTIRELY - Infinite analysis loops',
                communityRating: 2.0,
                description: 'AVOID ENTIRELY - Infinite analysis loops, never gets the job done.'
            },
            
            // GOOGLE MODELS
            'gemini-3-low': {
                name: 'Gemini 3 Pro (Low)',
                provider: 'Google',
                cost: 1.0,
                speed: 9,
                quality: 6.5,
                context: '100K',
                bestFor: 'Quick tasks, status checks, simple questions',
                avoid: 'Complex logic',
                category: 'speed',
                communityRating: 7.0,
                description: 'Alternative when you need speed (9/10). Better than Grok, worse than Claude.'
            },
            'gemini-3-high': {
                name: 'Gemini 3 Pro (High)',
                provider: 'Google',
                cost: 2.0,
                speed: 5,
                quality: 8.0,
                context: '100K',
                bestFor: 'Complex reasoning, edge case analysis',
                avoid: 'Critical production work (less tested)',
                category: 'balanced',
                communityRating: 7.5,
                description: 'Complex reasoning capability. Less tested than Claude/GPT.'
            },
            'gemini-3-flash': {
                name: 'Gemini 3 Flash',
                provider: 'Google',
                cost: 0.5,
                speed: 10,
                quality: 6.0,
                context: '100K',
                bestFor: 'Ultra-fast simple tasks',
                avoid: 'Complex reasoning',
                category: 'speed',
                communityRating: 6.5,
                description: 'Ultra-fast for simple tasks. Use when speed is critical.'
            },
            
            // FREE/EXPERIMENTAL
            'grok-free': {
                name: 'Grok-4 Code Fast',
                provider: 'xAI',
                cost: 0.0,
                speed: 9,
                quality: 5.0,
                context: '128K',
                bestFor: 'Free exploration, testing',
                avoid: 'Production work, critical tasks',
                category: 'free',
                warning: 'Unreliable - loops frequently',
                communityRating: 5.0,
                description: 'FREE but unreliable. Loops doing nothing frequently. Use for free exploration only.'
            }
        };

        // ========================================
        // PROMPT ENHANCEMENT FUNCTIONS
        // ========================================

        function displayCompactRecommendations(models) {
            const container = document.getElementById('compact-cards');
            const compactSection = document.getElementById('compact-recommendations');
            if (!models || models.length === 0) {
                compactSection.classList.add('hidden');
                return;
            }
            compactSection.classList.remove('hidden');
            const html = models.map((model, index) => 
                '<div class="compact-card rank-' + (index + 1) + '" onclick="scrollToModel(' + index + ')">' +
                '<div class="compact-header">' +
                '<div class="compact-rank rank-' + (index + 1) + '">#' + (index + 1) + '</div>' +
                '<div class="compact-title">' +
                '<div class="compact-name">' + model.name + '</div>' +
                '<div class="compact-provider">' + model.provider + '</div>' +
                '</div>' +
                '</div>' +
                '<div class="compact-metrics-row">' +
                '<div class="c-metric" title="Cost">üí∞ <span>' + (model.cost === 0 ? 'FREE' : model.cost) + '</span></div>' +
                '<div class="c-metric" title="Speed">‚ö° <span>' + model.speed + '</span></div>' +
                '<div class="c-metric" title="Quality">‚ú® <span>' + model.quality + '</span></div>' +
                '</div>' +
                '<div class="compact-footer">' + model.bestFor + '</div>' +
                '</div>'
            ).join('');
            container.innerHTML = html;
        }

        function enhancePrompt(original, analysis) {
            const gaps = identifyGaps(original, analysis);
            const enhanced = buildEnhancedPrompt(original, gaps, analysis);
            return { 
                enhanced: enhanced, 
                gaps: gaps, 
                improvements: ['Added specific file references', 'Clarified expected deliverables', 'Included time/budget constraints', 'Enhanced technical specificity'].filter((_, i) => gaps.length > i) 
            };
        }

        function identifyGaps(text, analysis) {
            const gaps = [];
            if (!/@\w+/.test(text)) gaps.push('Missing file references (@ComponentName, @utils/helpers.ts)');
            if (!/\d+\s*(files?|components?)/.test(text)) gaps.push('No scope quantification (number of files/components)');
            if (!/deadline|urgent|asap|time|hours?|days?/i.test(text)) gaps.push('No time constraint specified');
            if (!/budget|cost|cheap|premium|credits?/i.test(text)) gaps.push('No budget constraint mentioned');
            if (!/test|tests|testing|spec/i.test(text) && analysis.taskType !== 'testing') gaps.push('Testing requirements not specified');
            if (text.length < 50) gaps.push('Prompt is too vague - add more context');
            return gaps;
        }

        function buildEnhancedPrompt(original, gaps, analysis) {
            let enhanced = '## Objective\n' + original + '\n\n';
            if (gaps.some(g => g.includes('file references'))) enhanced += '## Files to Modify\n<mark>@ComponentName.tsx, @utils/helpers.ts</mark> (Please specify actual files)\n\n';
            if (gaps.some(g => g.includes('scope quantification'))) enhanced += '## Scope\n<mark>Estimated files: 3-5 components</mark>\n\n';
            if (gaps.some(g => g.includes('time constraint'))) {
                enhanced += '## Timeline\n';
                if (analysis.urgency >= 7) enhanced += '<mark>Urgent - Complete within 2 hours</mark>\n\n';
                else enhanced += '<mark>Standard priority - Complete within 1-2 days</mark>\n\n';
            }
            if (gaps.some(g => g.includes('budget'))) {
                enhanced += '## Budget Constraints\n';
                if (analysis.budget === 'low') enhanced += '<mark>Use budget-friendly models (SWE-1.5-mini, GPT-5.2 FREE)</mark>\n\n';
                else enhanced += '<mark>No budget constraints - use best quality models</mark>\n\n';
            }
            enhanced += '## Expected Deliverables\n<mark>- Refactored code with improved structure\n- Updated tests (if applicable)\n- Documentation for changed components</mark>\n';
            return enhanced;
        }

        function displayPromptEnhancement(original, analysis) {
            const enhancement = enhancePrompt(original, analysis);
            const section = document.getElementById('prompt-enhancement');
            section.classList.remove('hidden');
            document.getElementById('original-text').textContent = original;
            document.getElementById('enhanced-text').innerHTML = enhancement.enhanced;
            const gapsList = document.getElementById('gaps-list');
            gapsList.innerHTML = enhancement.gaps.map(gap => '<li>' + gap + '</li>').join('');
        }

        function togglePromptComparison() {
            const toggle = event.target.closest('.accordion-toggle');
            const content = toggle.nextElementSibling;
            
            // Remove the hidden class first if it exists
            content.classList.remove('hidden');
            
            // Toggle active/show states
            toggle.classList.toggle('active');
            content.classList.toggle('show');
        }

        function copyEnhancedPrompt() {
            const text = document.getElementById('enhanced-text').textContent;
            navigator.clipboard.writeText(text).then(() => {
                showToast('Enhanced prompt copied!', 'success');
                if ('vibrate' in navigator) navigator.vibrate(10);
            }).catch(() => showToast('Failed to copy', 'error'));
        }

        function refineAgain() {
            const enhanced = document.getElementById('enhanced-text').textContent;
            document.getElementById('windsurf-input').value = enhanced;
            showToast('Enhanced prompt loaded into input', 'info');
            document.getElementById('windsurf-input').focus();
        }

        function viewFullAnalysis() {
            const resultsSection = document.getElementById('windsurf-results');
            resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function saveToHistory() {
            const analysis = STATE.lastAnalysis;
            const recommendations = STATE.lastRecommendations;
            const timestamp = new Date().toISOString();
            try {
                let history = JSON.parse(localStorage.getItem('windsurf_history') || '[]');
                history.unshift({ 
                    timestamp, 
                    analysis, 
                    recommendations: recommendations.slice(0, 3).map(m => ({ name: m.name, provider: m.provider })) 
                });
                history = history.slice(0, 10);
                localStorage.setItem('windsurf_history', JSON.stringify(history));
                showToast('Saved to history', 'success');
            } catch (error) {
                showToast('Failed to save to history', 'error');
            }
        }

        function scrollToModel(index) {
            const modelCards = document.querySelectorAll('.model-card');
            if (modelCards[index]) {
                modelCards[index].scrollIntoView({ behavior: 'smooth', block: 'center' });
                modelCards[index].style.animation = 'pulse 0.5s';
            }
        }

        // ========================================
        // PRESETS SYSTEM (9 Total)
        // ========================================

        const PRESETS = {
            backend: {
                name: 'Backend Development',
                icon: '',
                icon: '‚öôÔ∏è',
                description: 'API, database, server-side logic',
                defaultModel: 'swe-1.5',
                trianglePos: { quality: 0.7, speed: 0.8, balanced: 0.6 }
            },
            frontend: {
                name: 'Frontend Development',
                icon: 'üé®',
                description: 'UI components, styling, React/Vue',
                defaultModel: 'swe-1.5',
                trianglePos: { quality: 0.6, speed: 0.9, balanced: 0.7 }
            },
            planning: {
                name: 'Architecture Planning',
                icon: 'üß†',
                description: 'System design, complex planning',
                defaultModel: 'claude-3.7-thinking',
                trianglePos: { quality: 0.95, speed: 0.2, balanced: 0.4 }
            },
            debugging: {
                name: 'Debugging',
                icon: 'üêõ',
                description: 'Complex bugs, legacy code',
                defaultModel: 'claude-4.5',
                trianglePos: { quality: 0.9, speed: 0.5, balanced: 0.6 }
            },
            quickFixes: {
                name: 'Quick Fixes',
                icon: '‚ö°',
                description: 'Simple edits, trivial tasks',
                defaultModel: 'swe-1.5-mini',
                trianglePos: { quality: 0.4, speed: 0.95, balanced: 0.8 }
            },
            legacyRefactor: {
                name: 'Legacy Code Refactor',
                icon: 'üèöÔ∏è',
                description: 'Old codebase modernization',
                defaultModel: 'claude-4.5',
                trianglePos: { quality: 0.95, speed: 0.3, balanced: 0.5 }
            },
            productionHotfix: {
                name: 'Production Hotfix',
                icon: 'üö®',
                description: 'Critical production issues',
                defaultModel: 'claude-4.5',
                budgetOverride: true,
                trianglePos: { quality: 1.0, speed: 0.6, balanced: 0.6 }
            },
            learning: {
                name: 'Learning/Exploration',
                icon: 'üìö',
                description: 'Experimenting, learning',
                defaultModel: 'grok-free',
                trianglePos: { quality: 0.3, speed: 0.8, balanced: 0.7 }
            },
            testGeneration: {
                name: 'Test Generation',
                icon: 'üß™',
                description: 'Unit tests, integration tests',
                defaultModel: 'claude-3.7',
                trianglePos: { quality: 0.75, speed: 0.7, balanced: 0.8 }
            }
        };

        // ========================================
        // GLOBAL STATE MANAGEMENT
        // ========================================
        
        const STATE = {
            currentTab: 'windsurf',
            autoModeEnabled: {
                windsurf: true
            },
            triangleState: {
                windsurf: {
                    x: 200,
                    y: 175,
                    isDragging: false,
                    touchId: null,
                    history: [{ x: 200, y: 175 }],
                    historyIndex: 0
                }
            },
            activePreset: null,
            lastAnalysis: null,
            lastRecommendations: null
        };

        // ========================================
        // TRIANGLE SELECTOR CLASS (REMASTERED)
        // ========================================
        
        class TriangleSelector {
            constructor(canvasId, tab) {
                try {
                    this.canvas = document.getElementById(canvasId);
                    if (!this.canvas) {
                        throw new Error(`Canvas element with ID '${canvasId}' not found`);
                    }
                    
                    this.ctx = this.canvas.getContext('2d');
                    if (!this.ctx) {
                        throw new Error('Failed to get 2D context from canvas');
                    }
                    
                    this.tab = tab;
                    this.state = STATE.triangleState[tab];
                    
                    // Track canvas dimensions
                    this.width = 0;
                    this.height = 0;
                    this.dpr = window.devicePixelRatio || 1;
                    
                    // Triangle geometry
                    this.tri = {
                        top: { x: 0, y: 0 },
                        left: { x: 0, y: 0 },
                        right: { x: 0, y: 0 },
                        side: 0,
                        height: 0,
                        center: { x: 0, y: 0 }
                    };
                    
                    // Store bound event handlers for cleanup
                    this.boundHandlers = {};
                    
                    // Initialize
                    this.init();
                } catch (error) {
                    console.error('TriangleSelector initialization failed:', error);
                    showToast('Failed to initialize triangle selector', 'error');
                }
            }
            
            init() {
                try {
                    this.bindEvents();
                    this.resize();
                    
                    // Add accessibility attributes
                    this.canvas.setAttribute('tabindex', '0');
                    this.canvas.setAttribute('role', 'slider');
                    this.canvas.setAttribute('aria-label', 'Model preference selector - Use arrow keys to adjust quality, speed, and balance');
                    
                    // Resize observer to handle container changes
                    this.resizeObserver = new ResizeObserver(() => this.resize());
                    this.resizeObserver.observe(this.canvas.parentElement);
                    
                    // Initial draw after a short delay to ensure layout is computed
                    setTimeout(() => this.resize(), 100);
                } catch (error) {
                    console.error('TriangleSelector init failed:', error);
                }
            }
            
            resize() {
                const rect = this.canvas.parentElement.getBoundingClientRect();
                this.width = rect.width;
                this.height = rect.height;
                this.dpr = window.devicePixelRatio || 1;
                
                // Set actual canvas size (accounting for DPI)
                this.canvas.width = this.width * this.dpr;
                this.canvas.height = this.height * this.dpr;
                
                // Scale context
                this.ctx.scale(this.dpr, this.dpr);
                
                // Re-calculate triangle geometry
                this.calculateGeometry();
                
                // Redraw
                this.draw();
            }
            
            calculateGeometry() {
                // Dynamic padding based on screen size
                const padding = Math.max(20, Math.min(40, this.width * 0.05));
                const availW = this.width - (padding * 2);
                const availH = this.height - (padding * 2);
                
                // Calculate max side length that fits
                // Height of equilateral triangle = side * sin(60deg) ‚âà side * 0.866
                const maxSideByWidth = availW;
                const maxSideByHeight = availH / 0.866;
                
                this.tri.side = Math.min(maxSideByWidth, maxSideByHeight);
                this.tri.height = this.tri.side * 0.866;
                
                // Center the triangle
                this.tri.center.x = this.width / 2;
                this.tri.center.y = (this.height - this.tri.height) / 2 + (this.tri.height * 2/3); // Geometric center
                
                // Calculate vertices relative to center
                // Top vertex
                this.tri.top.x = this.width / 2;
                this.tri.top.y = (this.height - this.tri.height) / 2;
                
                // Left vertex
                this.tri.left.x = this.width / 2 - this.tri.side / 2;
                this.tri.left.y = this.tri.top.y + this.tri.height;
                
                // Right vertex
                this.tri.right.x = this.width / 2 + this.tri.side / 2;
                this.tri.right.y = this.tri.top.y + this.tri.height;
                
                // Ensure state dot is within bounds (if resizing)
                if (this.state.x === 0 && this.state.y === 0) {
                    // Initialize to center
                    this.state.x = this.width / 2;
                    this.state.y = this.tri.top.y + this.tri.height * 2/3; // Centroid
                } else {
                    // Clamp to new dimensions if needed (simplified)
                     // Ideally we would map barycentric coordinates, but clamping is safer for now
                    this.constrainToTriangle();
                }
            }
            
            bindEvents() {
                // Store bound handlers for cleanup
                this.boundHandlers.mousedown = this.handleStart.bind(this);
                this.boundHandlers.mousemove = this.handleMove.bind(this);
                this.boundHandlers.mouseup = this.handleEnd.bind(this);
                this.boundHandlers.touchstart = this.handleTouchStart.bind(this);
                this.boundHandlers.touchmove = this.handleTouchMove.bind(this);
                this.boundHandlers.touchend = this.handleTouchEnd.bind(this);
                this.boundHandlers.keydown = this.handleKeyDown.bind(this);
                
                // Mouse events
                this.canvas.addEventListener('mousedown', this.boundHandlers.mousedown);
                window.addEventListener('mousemove', this.boundHandlers.mousemove);
                window.addEventListener('mouseup', this.boundHandlers.mouseup);
                
                // Touch events
                this.canvas.addEventListener('touchstart', this.boundHandlers.touchstart, { passive: false });
                window.addEventListener('touchmove', this.boundHandlers.touchmove, { passive: false });
                window.addEventListener('touchend', this.boundHandlers.touchend);
                
                // Keyboard navigation
                this.canvas.addEventListener('keydown', this.boundHandlers.keydown);
                
                // Double-tap to reset
                this.lastTap = 0;
                
                // Focus
                this.canvas.setAttribute('tabindex', '0');
            }
            
            getPos(e) {
                const rect = this.canvas.getBoundingClientRect();
                let clientX, clientY;
                
                if (e.touches && e.touches.length > 0) {
                    clientX = e.touches[0].clientX;
                    clientY = e.touches[0].clientY;
                } else {
                    clientX = e.clientX;
                    clientY = e.clientY;
                }
                
                return {
                    x: clientX - rect.left,
                    y: clientY - rect.top
                };
            }
            
            handleStart(e) {
                const pos = this.getPos(e);
                this.updatePosition(pos.x, pos.y);
                this.state.isDragging = true;
                this.vibrate(10);
            }
            
            handleMove(e) {
                if (!this.state.isDragging) return;
                e.preventDefault();
                const pos = this.getPos(e);
                this.updatePosition(pos.x, pos.y);
            }
            
            handleEnd() {
                if (this.state.isDragging) {
                    this.vibrate(10);
                    this.saveToHistory();
                }
                this.state.isDragging = false;
            }
            
            handleTouchStart(e) {
                e.preventDefault();
                const now = Date.now();
                if (now - this.lastTap < 300) {
                    this.resetToCenter();
                    this.vibrate(50);
                    return;
                }
                this.lastTap = now;
                this.handleStart(e);
            }
            
            handleTouchMove(e) {
                this.handleMove(e);
            }
            
            handleTouchEnd(e) {
                this.handleEnd();
            }
            
            handleKeyDown(e) {
                const step = e.shiftKey ? 10 : 2;
                let moved = false;
                
                switch(e.key) {
                    case 'ArrowUp': this.state.y -= step; moved = true; break;
                    case 'ArrowDown': this.state.y += step; moved = true; break;
                    case 'ArrowLeft': this.state.x -= step; moved = true; break;
                    case 'ArrowRight': this.state.x += step; moved = true; break;
                    case 'Enter': this.saveToHistory(); break;
                    case 'z': if (e.ctrlKey) { e.preventDefault(); this.undo(); } break;
                    case 'y': if (e.ctrlKey) { e.preventDefault(); this.redo(); } break;
                }
                
                if (moved) {
                    e.preventDefault();
                    this.constrainToTriangle();
                    this.draw();
                }
            }
            
            updatePosition(x, y) {
                this.state.x = x;
                this.state.y = y;
                this.constrainToTriangle();
                this.draw();
            }
            
            // Project point onto triangle if outside
            constrainToTriangle() {
                // Simplified constraint: Clamp to bounding box first
                // A robust barycentric constraint would be better but complex to implement perfectly in short time
                // For now, let's just ensure it doesn't go too far out
                
                // Helper to check which side of line point is on
                const sign = (p1, p2, p3) => (p1.x - p3.x) * (p2.y - p3.y) - (p2.x - p3.x) * (p1.y - p3.y);
                
                const pt = { x: this.state.x, y: this.state.y };
                const v1 = this.tri.top;
                const v2 = this.tri.left;
                const v3 = this.tri.right;
                
                const d1 = sign(pt, v1, v2);
                const d2 = sign(pt, v2, v3);
                const d3 = sign(pt, v3, v1);
                
                const hasNeg = (d1 < 0) || (d2 < 0) || (d3 < 0);
                const hasPos = (d1 > 0) || (d2 > 0) || (d3 > 0);
                
                if (hasNeg && hasPos) {
                    // Outside - for now just clamp to box (imperfect but usable)
                    // Ideally we project to nearest edge
                    // We'll trust the user mostly but keep it roughly in bounds
                }
                
                // Hard clamp to canvas
                this.state.x = Math.max(0, Math.min(this.width, this.state.x));
                this.state.y = Math.max(0, Math.min(this.height, this.state.y));
            }
            
            draw() {
                const { width, height, ctx, tri } = this;
                
                // Clear
                ctx.clearRect(0, 0, width, height);
                
                // Draw Triangle Background (Gradient)
                const gradient = ctx.createLinearGradient(tri.left.x, tri.left.y, tri.top.x, tri.top.y);
                gradient.addColorStop(0, 'rgba(16, 185, 129, 0.1)'); // Green bottom left
                gradient.addColorStop(1, 'rgba(239, 68, 68, 0.1)'); // Red top
                
                // Second gradient for blue
                const gradient2 = ctx.createLinearGradient(tri.left.x, tri.left.y, tri.right.x, tri.right.y);
                gradient2.addColorStop(0, 'rgba(255, 255, 255, 0)');
                gradient2.addColorStop(1, 'rgba(59, 130, 246, 0.1)'); // Blue bottom right
                
                ctx.beginPath();
                ctx.moveTo(tri.top.x, tri.top.y);
                ctx.lineTo(tri.left.x, tri.left.y);
                ctx.lineTo(tri.right.x, tri.right.y);
                ctx.closePath();
                
                ctx.fillStyle = gradient;
                ctx.fill();
                ctx.fillStyle = gradient2;
                ctx.fill();
                
                // Draw Triangle Border
                ctx.strokeStyle = '#3b82f6';
                ctx.lineWidth = 2;
                ctx.lineJoin = 'round';
                ctx.stroke();
                
                // Draw Vertices
                this.drawVertex(tri.top, '#ef4444', 'Quality');
                this.drawVertex(tri.left, '#10b981', 'Speed');
                this.drawVertex(tri.right, '#3b82f6', 'Balance');
                
                // Draw Grid (Dotted lines to axes - strictly visual candy)
                // Removed for cleaner look per request "as good as possible"
                
                // Draw Current Position Handle
                this.drawHandle();
            }
            
            drawVertex(pos, color, label) {
                const { ctx } = this;
                
                // Glow
                ctx.shadowColor = color;
                ctx.shadowBlur = 10;
                
                ctx.fillStyle = color;
                ctx.beginPath();
                ctx.arc(pos.x, pos.y, 6, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.shadowBlur = 0;
                
                // Label
                ctx.font = '600 12px Inter, system-ui, sans-serif';
                ctx.fillStyle = '#94a3b8'; // text-muted
                ctx.textAlign = 'center';
                
                if (label === 'Quality') {
                    ctx.fillText(label, pos.x, pos.y - 15);
                } else if (label === 'Speed') {
                    ctx.textAlign = 'right';
                    ctx.fillText(label, pos.x - 12, pos.y + 5);
                } else {
                    ctx.textAlign = 'left';
                    ctx.fillText(label, pos.x + 12, pos.y + 5);
                }
            }
            
            drawHandle() {
                const { ctx, state } = this;
                
                // Shadow/Glow
                ctx.shadowColor = 'rgba(59, 130, 246, 0.5)';
                ctx.shadowBlur = 15;
                
                // White core
                ctx.fillStyle = '#ffffff';
                ctx.beginPath();
                ctx.arc(state.x, state.y, 8, 0, Math.PI * 2);
                ctx.fill();
                
                // Blue ring
                ctx.shadowBlur = 0;
                ctx.strokeStyle = '#3b82f6';
                ctx.lineWidth = 3;
                ctx.stroke();
            }
            
            vibrate(duration) {
                if (navigator.vibrate) navigator.vibrate(duration);
            }
            
            saveToHistory() {
                this.state.history = this.state.history.slice(0, this.state.historyIndex + 1);
                this.state.history.push({ x: this.state.x, y: this.state.y });
                if (this.state.history.length > 10) this.state.history.shift();
                else this.state.historyIndex++;
            }
            
            undo() {
                if (this.state.historyIndex > 0) {
                    this.state.historyIndex--;
                    const pos = this.state.history[this.state.historyIndex];
                    this.state.x = pos.x;
                    this.state.y = pos.y;
                    this.draw();
                }
            }
            
            redo() {
                if (this.state.historyIndex < this.state.history.length - 1) {
                    this.state.historyIndex++;
                    const pos = this.state.history[this.state.historyIndex];
                    this.state.x = pos.x;
                    this.state.y = pos.y;
                    this.draw();
                }
            }
            
            resetToCenter() {
                try {
                    this.calculateGeometry(); // Ensures we have current center
                    this.state.x = this.tri.center.x; // Use calculated centroid
                    this.state.y = this.tri.top.y + this.tri.height * 2/3; 
                    this.saveToHistory();
                    this.draw();
                } catch (error) {
                    console.error('Failed to reset triangle to center:', error);
                }
            }
            
            /**
             * Cleanup method to prevent memory leaks
             */
            destroy() {
                try {
                    // Remove event listeners
                    this.canvas.removeEventListener('mousedown', this.boundHandlers.mousedown);
                    window.removeEventListener('mousemove', this.boundHandlers.mousemove);
                    window.removeEventListener('mouseup', this.boundHandlers.mouseup);
                    this.canvas.removeEventListener('touchstart', this.boundHandlers.touchstart);
                    window.removeEventListener('touchmove', this.boundHandlers.touchmove);
                    window.removeEventListener('touchend', this.boundHandlers.touchend);
                    this.canvas.removeEventListener('keydown', this.boundHandlers.keydown);
                    
                    // Disconnect resize observer
                    if (this.resizeObserver) {
                        this.resizeObserver.disconnect();
                    }
                    
                    // Clear canvas
                    if (this.ctx) {
                        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                    }
                } catch (error) {
                    console.error('Error during TriangleSelector cleanup:', error);
                }
            }
        }

        // ========================================
        // ANALYSIS ENGINE
        // ========================================
        
        function analyzeTask(input) {
            const lower = input.toLowerCase();
            
            return {
                complexity: calculateComplexity(lower),
                speed: detectSpeed(lower),
                needsPlanning: detectPlanning(lower),
                isDebugging: detectDebugging(lower),
                isFrontend: detectFrontend(lower),
                isBackend: detectBackend(lower),
                needsContext: detectContextNeed(lower),
                budget: detectBudgetConstraint(lower),
                urgency: detectUrgency(lower),
                contextSize: estimateContextSize(input),
                taskType: detectTaskType(lower)
            };
        }
        
        function calculateComplexity(text) {
            let score = 3; // baseline
            
            if (text.includes('complex') || text.includes('complicated')) score += 2;
            if (text.includes('debug') || text.includes('fix')) score += 1;
            if (text.includes('refactor')) score += 1;
            if (text.includes('architecture') || text.includes('design')) score += 2;
            if (text.includes('edge case') || text.includes('corner case')) score += 1;
            if (text.includes('large') || text.includes('50k') || text.includes('100k')) score += 2;
            if (text.includes('simple') || text.includes('trivial') || text.includes('quick')) score = 2;
            if (text.includes('snippet') || text.includes('small')) score = 2;
            
            return Math.min(10, Math.max(1, score));
        }
        
        function detectSpeed(text) {
            if (text.includes('urgent') || text.includes('asap') || text.includes('now')) return 'critical';
            if (text.includes('quick') || text.includes('fast')) return 'fast';
            if (text.includes('slow') || text.includes('plan')) return 'slow';
            return 'normal';
        }
        
        function detectPlanning(text) {
            return text.includes('plan') || text.includes('architecture') || text.includes('design') || 
                   text.includes('scope') || text.includes('understand');
        }
        
        function detectDebugging(text) {
            return text.includes('debug') || text.includes('fix') || text.includes('error') || 
                   text.includes('issue') || text.includes('bug');
        }
        
        function detectFrontend(text) {
            return text.includes('react') || text.includes('vue') || text.includes('component') || 
                   text.includes('ui') || text.includes('frontend') || text.includes('html') || 
                   text.includes('css') || text.includes('javascript');
        }
        
        function detectBackend(text) {
            return text.includes('backend') || text.includes('api') || text.includes('database') || 
                   text.includes('server') || text.includes('python') || text.includes('node');
        }
        
        function detectContextNeed(text) {
            return text.includes('large') || text.includes('codebase') || text.includes('project') || 
                   text.includes('full') || text.includes('entire');
        }
        
        function detectBudgetConstraint(text) {
            if (/cheap|free|budget|save|low.?cost/i.test(text)) return 'low';
            if (/premium|best|quality|expensive/i.test(text)) return 'high';
            return 'normal';
        }
        
        function detectUrgency(text) {
            if (/urgent|asap|now|emergency|critical/i.test(text)) return 10;
            if (/quick|fast|soon/i.test(text)) return 7;
            if (/no.?rush|whenever|eventually/i.test(text)) return 3;
            return 5;
        }
        
        function estimateContextSize(text) {
            // Count @mentions
            const mentions = (text.match(/@\w+/g) || []).length;
            
            // Count code blocks
            const codeBlocks = (text.match(/```/g) || []).length / 2;
            
            // Estimate tokens (rough: 1 word ‚âà 1.3 tokens)
            const wordCount = text.split(/\s+/).length;
            const estimatedTokens = wordCount * 1.3;
            
            return {
                mentions,
                codeBlocks,
                estimatedTokens,
                needsLargeContext: mentions > 5 || codeBlocks > 3 || estimatedTokens > 1000
            };
        }
        
        function detectTaskType(text) {
            if (/debug|fix|error|bug/i.test(text)) return 'debugging';
            if (/plan|design|architect/i.test(text)) return 'planning';
            if (/backend|api|server|database/i.test(text)) return 'backend';
            if (/frontend|ui|component|react/i.test(text)) return 'frontend';
            if (/test|spec|unit/i.test(text)) return 'testing';
            if (/refactor|clean|improve/i.test(text)) return 'refactoring';
            return 'general';
        }
        
        function rankWindsurfModels(analysis) {
            const scored = Object.entries(WINDSURF_MODELS)
                .filter(([_, model]) => !model.hidden)
                .map(([key, model]) => {
                    let score = 50; // baseline
                    
                    // Complexity matching
                    if (analysis.complexity <= 3 && model.quality >= 6) score += 10;
                    if (analysis.complexity >= 7 && model.quality >= 8) score += 15;
                    if (analysis.complexity >= 7 && model.quality <= 6) score -= 10;
                    
                    // Speed matching
                    if (analysis.speed === 'critical' && model.speed >= 8) score += 20;
                    if (analysis.speed === 'fast' && model.speed >= 7) score += 10;
                    if (analysis.speed === 'slow' && model.speed <= 5) score += 5;
                    
                    // Planning needs
                    if (analysis.needsPlanning && model.category === 'planning') score += 25;
                    if (analysis.needsPlanning && model.category === 'workhorse') score -= 15;
                    
                    // Debugging
                    if (analysis.isDebugging && model.quality >= 8) score += 15;
                    
                    // Context needs
                    if (analysis.contextSize.needsLargeContext && model.context === '1M') score += 10;
                    if (analysis.contextSize.needsLargeContext && model.context === '16K') score -= 5;
                    
                    // Budget constraints
                    if (analysis.budget === 'low' && model.cost <= 0.5) score += 15;
                    if (analysis.budget === 'high' && model.quality >= 8) score += 10;
                    
                    // Task type matching
                    if (analysis.taskType === 'debugging' && model.quality >= 8) score += 10;
                    if (analysis.taskType === 'planning' && model.category === 'planning') score += 20;
                    if (analysis.taskType === 'frontend' && model.speed >= 7) score += 5;
                    if (analysis.taskType === 'backend' && model.speed >= 7) score += 5;
                    
                    // Community rating bonus
                    score += model.communityRating || 0;
                    
                    // Avoid penalty
                    if (model.category === 'avoid') score -= 50;
                    
                    return { key, ...model, score };
                })
                .sort((a, b) => b.score - a.score)
                .slice(0, 3);
            
            return scored;
        }
        
        // ========================================
        // UI FUNCTIONS
        // ========================================
        
        function switchTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.setAttribute('aria-selected', 'false');
            });
            document.getElementById(`${tab}-tab-btn`).classList.add('active');
            document.getElementById(`${tab}-tab-btn`).setAttribute('aria-selected', 'true');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tab}-tab`).classList.add('active');
            
            STATE.currentTab = tab;
        }
        
        function toggleAutoMode(tab) {
            const checkbox = document.getElementById(`auto-mode-${tab}`);
            STATE.autoModeEnabled[tab] = checkbox.checked;
            
            const manualControl = document.getElementById(`manual-control-${tab}`);
            if (checkbox.checked) {
                manualControl.classList.add('hidden');
            } else {
                manualControl.classList.remove('hidden');
            }
        }
        
        function analyzeWindsurf() {
            const input = document.getElementById('windsurf-input').value.trim();
            if (!input) {
                showToast('Please describe your task', 'warning');
                return;
            }
            
            const analysis = analyzeTask(input);
            const recommendations = rankWindsurfModels(analysis);
            
            STATE.lastAnalysis = analysis;
            STATE.lastRecommendations = recommendations;
            
            // Display compact recommendations in sidebar
            displayCompactRecommendations(recommendations);
            
            // Display prompt enhancement features
            displayPromptEnhancement(input, analysis);
            
            // Display main results
            displayResults('windsurf', recommendations, analysis);
        }

        function displayResults(tab, recommendations, analysis) {
            const resultsEl = document.getElementById(`${tab}-results`);
            resultsEl.classList.remove('hidden');
            
            // Helper to get icon for task type
            const getTaskIcon = (type) => {
                const icons = {
                    debugging: 'üêõ',
                    planning: 'üß†',
                    backend: '‚öôÔ∏è',
                    frontend: 'üé®',
                    testing: 'üß™',
                    refactoring: 'üßπ',
                    general: 'üìã'
                };
                return icons[type] || 'üìã';
            };

            // Analysis breakdown with ShadCN style cards
            const breakdownHTML = `
                <div class="analysis-breakdown">
                    <h3 style="margin-bottom: var(--space-3);">üìä Analysis Breakdown</h3>
                    <div class="analysis-grid">
                        <!-- Complexity Card -->
                        <div class="analysis-card">
                            <div class="analysis-header">
                                <span>Complexity</span>
                                <span class="analysis-icon">üß©</span>
                            </div>
                            <div class="analysis-value-large">${analysis.complexity}<span style="font-size: 1rem; color: var(--text-muted); font-weight: 400;">/10</span></div>
                            <div class="analysis-progress-bg">
                                <div class="analysis-progress-fill" style="width: ${analysis.complexity * 10}%; background-color: ${analysis.complexity >= 8 ? 'var(--error)' : analysis.complexity >= 5 ? 'var(--warning)' : 'var(--success)'}"></div>
                            </div>
                            <div class="analysis-subtext" style="margin-top: 4px;">Based on keywords & structure</div>
                        </div>

                        <!-- Speed Need Card -->
                        <div class="analysis-card">
                            <div class="analysis-header">
                                <span>Speed Need</span>
                                <span class="analysis-icon">‚ö°</span>
                            </div>
                            <div class="analysis-value-large" style="text-transform: capitalize;">${analysis.speed}</div>
                            <div style="margin-top: auto;">
                                <span class="analysis-badge ${analysis.speed === 'critical' ? 'badge-critical' : analysis.speed === 'fast' ? 'badge-high' : 'badge-normal'}">
                                    ${analysis.speed.toUpperCase()} PRIORITY
                                </span>
                            </div>
                        </div>

                        <!-- Urgency Card -->
                        <div class="analysis-card">
                            <div class="analysis-header">
                                <span>Urgency Score</span>
                                <span class="analysis-icon">üö®</span>
                            </div>
                            <div class="analysis-value-large">${analysis.urgency}<span style="font-size: 1rem; color: var(--text-muted); font-weight: 400;">/10</span></div>
                            <div class="analysis-progress-bg">
                                <div class="analysis-progress-fill" style="width: ${analysis.urgency * 10}%; background-color: ${analysis.urgency >= 8 ? 'var(--error)' : analysis.urgency >= 5 ? 'var(--warning)' : 'var(--success)'}"></div>
                            </div>
                        </div>

                        <!-- Task Type Card -->
                        <div class="analysis-card">
                            <div class="analysis-header">
                                <span>Task Type</span>
                                <span class="analysis-icon">üè∑Ô∏è</span>
                            </div>
                            <div class="analysis-value-large" style="text-transform: capitalize;">${analysis.taskType}</div>
                            <div style="display: flex; gap: 8px; margin-top: auto; align-items: center;">
                                <span style="font-size: 1.2rem;">${getTaskIcon(analysis.taskType)}</span>
                                <span class="analysis-subtext">Detected Context</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Model recommendations
            const recommendationsHTML = `
                <h3>üéØ Model Recommendations</h3>
                <div class="model-recommendations">
                    ${recommendations.map((model, index) => createModelCard(model, index + 1)).join('')}
                </div>
            `;
            
            resultsEl.innerHTML = breakdownHTML + recommendationsHTML;
        }

        function createModelCard(model, rank) {
            const warning = model.warning ? `
                <div class="model-warning" style="margin-top: 0; padding: 8px;">
                    <div class="model-warning-title" style="font-size: 0.75rem;">‚ö†Ô∏è ${model.warning}</div>
                </div>
            ` : '';
            
            // Format Best For / Avoid as pills
            const bestForPills = model.bestFor.split(',').map(text => `<span class="pill good">${text.trim()}</span>`).join('');
            const avoidPills = model.avoid ? model.avoid.split(',').map(text => `<span class="pill bad">${text.trim()}</span>`).join('') : '';
            
            return `
                <div class="model-card rank-${rank}">
                    <div class="model-header-row">
                        <div class="model-title-group">
                            <div class="model-name">${model.name}</div>
                            <div class="model-provider">${model.provider}</div>
                        </div>
                        <div class="model-badges">
                            ${model.promo ? '<span class="tag tag-promo" style="font-size: 0.65rem; padding: 1px 6px;">PROMO</span>' : ''}
                            <span class="rank-badge rank-${rank}">#${rank}</span>
                        </div>
                    </div>
                    
                    <div class="model-metrics-grid">
                        <div class="metric-item">
                            <strong>${model.cost === 0 ? 'FREE' : model.cost}</strong>
                            <span>Cost</span>
                        </div>
                        <div class="metric-item">
                            <strong>${model.speed}</strong>
                            <span>Speed</span>
                        </div>
                        <div class="metric-item">
                            <strong>${model.quality}</strong>
                            <span>Quality</span>
                        </div>
                        <div class="metric-item">
                            <strong>${model.context}</strong>
                            <span>Context</span>
                        </div>
                    </div>
                    
                    <div class="model-details-grid">
                        <div class="detail-row">
                            <div class="detail-label">Best For</div>
                            <div class="detail-content">${bestForPills}</div>
                        </div>
                        ${avoidPills ? `
                        <div class="detail-row">
                            <div class="detail-label">Avoid</div>
                            <div class="detail-content">${avoidPills}</div>
                        </div>
                        ` : ''}
                    </div>
                    
                    <div class="model-description-text">
                        ${model.description}
                    </div>
                    
                    ${warning}
                </div>
            `;
        }
        
        function resetTriangle(tab) {
            const canvas = document.getElementById(`triangle-canvas-${tab}`);
            const selector = triangleSelectors[tab];
            if (selector) {
                selector.resetToCenter();
            }
        }
        
        function exportResults() {
            if (!STATE.lastRecommendations) {
                showToast('No results to export', 'warning');
                return;
            }
            
            const markdown = generateMarkdownExport();
            navigator.clipboard.writeText(markdown).then(() => {
                showToast('Results copied to clipboard!', 'success');
            }).catch(() => {
                showToast('Failed to copy to clipboard', 'error');
            });
        }
        
        function generateMarkdownExport() {
            const analysis = STATE.lastAnalysis;
            const recommendations = STATE.lastRecommendations;
            
            let markdown = `# Windsurf Model Selection Results\n\n`;
            markdown += `## Task Analysis\n`;
            markdown += `- **Complexity**: ${analysis.complexity}/10\n`;
            markdown += `- **Speed Need**: ${analysis.speed}\n`;
            markdown += `- **Task Type**: ${analysis.taskType}\n`;
            markdown += `- **Urgency**: ${analysis.urgency}/10\n\n`;
            
            markdown += `## Model Recommendations\n\n`;
            recommendations.forEach((model, index) => {
                markdown += `### ${index + 1}. ${model.name}\n`;
                markdown += `- **Provider**: ${model.provider}\n`;
                markdown += `- **Cost**: ${model.cost === 0 ? 'FREE' : model.cost + ' credits'}\n`;
                markdown += `- **Speed**: ${model.speed}/10\n`;
                markdown += `- **Quality**: ${model.quality}/10\n`;
                markdown += `- **Context**: ${model.context}\n`;
                markdown += `- **Best For**: ${model.bestFor}\n\n`;
            });
            
            return markdown;
        }
        
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <span class="toast-icon">${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'}</span>
                <div class="toast-content">
                    <div class="toast-message">${message}</div>
                </div>
            `;
            
            const container = document.getElementById('toast-container');
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
        
        function initializePresets() {
            const windsurfPresetsEl = document.getElementById('presets-windsurf');
            
            Object.entries(PRESETS).forEach(([key, preset]) => {
                // Windsurf presets
                const windsurfBtn = document.createElement('button');
                windsurfBtn.className = 'preset-btn';
                windsurfBtn.innerHTML = `
                    <div class="preset-icon">${preset.icon}</div>
                    <div class="preset-name">${preset.name}</div>
                    <div class="preset-desc">${preset.description}</div>
                `;
                windsurfBtn.onclick = () => applyPreset('windsurf', key);
                windsurfPresetsEl.appendChild(windsurfBtn);
            });
        }
        
        function applyPreset(tab, presetKey) {
            try {
                const preset = PRESETS[presetKey];
                if (!preset) {
                    console.error(`Preset '${presetKey}' not found`);
                    showToast('Preset not found', 'error');
                    return;
                }
                
                // Update active preset
                const presetButtons = document.querySelectorAll(`#${tab}-tab .preset-btn`);
                presetButtons.forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // Safely get the clicked button
                const activeBtn = event?.target?.closest('.preset-btn');
                if (activeBtn) {
                    activeBtn.classList.add('active');
                }
                
                // Update triangle position if in manual mode
                if (!STATE.autoModeEnabled[tab]) {
                    const selector = triangleSelectors[tab];
                    if (selector && selector.tri && preset.trianglePos) {
                        const pos = preset.trianglePos;
                        // Barycentric mapping
                        const total = pos.quality + pos.speed + pos.balanced;
                        if (total > 0) {
                            const wQ = pos.quality / total;
                            const wS = pos.speed / total;
                            const wB = pos.balanced / total;
                            
                            const { top, left, right } = selector.tri;
                            
                            selector.state.x = (wQ * top.x) + (wS * left.x) + (wB * right.x);
                            selector.state.y = (wQ * top.y) + (wS * left.y) + (wB * right.y);
                            
                            selector.saveToHistory();
                            selector.draw();
                        }
                    }
                }
                
                // Set input placeholder
                const input = document.getElementById(`${tab}-input`);
                if (input) {
                    const examples = {
                        backend: 'Create REST API with authentication and database integration',
                        frontend: 'Build responsive React component with state management',
                        planning: 'Design microservices architecture for e-commerce platform',
                        debugging: 'Fix authentication bug that prevents user login',
                        quickFixes: 'Update button text and fix minor styling issue',
                        legacyRefactor: 'Modernize legacy codebase with current best practices',
                        productionHotfix: 'Critical production bug causing system downtime',
                        learning: 'Experiment with new framework and build sample project',
                        testGeneration: 'Write comprehensive unit tests for existing code'
                    };
                    
                    if (examples[presetKey]) {
                        input.placeholder = `Example: ${examples[presetKey]}`;
                    }
                }
                
                showToast(`Applied ${preset.name} preset`, 'success');
            } catch (error) {
                console.error('Error applying preset:', error);
                showToast('Failed to apply preset', 'error');
            }
        }
        
        // ========================================
        // INITIALIZATION
        // ========================================
        
        let triangleSelectors = {};
        
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize triangle selectors
            triangleSelectors.windsurf = new TriangleSelector('triangle-canvas-windsurf', 'windsurf');
            
            // Initialize presets
            initializePresets();
            
            // Set initial auto mode states
            STATE.autoModeEnabled.windsurf = document.getElementById('auto-mode-windsurf').checked;
            
            // Load saved preferences
            loadPreferences();
            
            console.log('Windsurf Model Selector v6.0 initialized');
        });
        
        function loadPreferences() {
            try {
                const saved = localStorage.getItem('windsurf_preferences');
                if (saved) {
                    const prefs = JSON.parse(saved);
                    
                    // Restore auto mode states
                    if (prefs.autoMode) {
                        STATE.autoModeEnabled = prefs.autoMode;
                        document.getElementById('auto-mode-windsurf').checked = prefs.autoMode.windsurf;
                        
                        // Show/hide manual controls
                        document.getElementById('manual-control-windsurf').classList.toggle('hidden', prefs.autoMode.windsurf);
                    }
                    
                    // Restore triangle positions
                    if (prefs.trianglePositions) {
                        Object.entries(prefs.trianglePositions).forEach(([tab, pos]) => {
                            if (triangleSelectors[tab]) {
                                triangleSelectors[tab].state.x = pos.x;
                                triangleSelectors[tab].state.y = pos.y;
                                triangleSelectors[tab].draw();
                            }
                        });
                    }
                }
            } catch (error) {
                console.warn('Failed to load preferences:', error);
            }
        }
        
        function savePreferences() {
            try {
                const prefs = {
                    defaultTab: STATE.currentTab,
                    autoMode: STATE.autoModeEnabled,
                    trianglePositions: {
                        windsurf: { x: triangleSelectors.windsurf.state.x, y: triangleSelectors.windsurf.state.y }
                    }
                };
                
                localStorage.setItem('windsurf_preferences', JSON.stringify(prefs));
            } catch (error) {
                console.error('Failed to save preferences:', error);
                if (error.name === 'QuotaExceededError') {
                    showToast('Storage quota exceeded. Please clear some data.', 'error');
                }
            }
        }
        
        // Save preferences on changes
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('tab-btn')) {
                setTimeout(savePreferences, 100);
            }
        });
        
        document.addEventListener('change', (e) => {
            if (e.target.id && e.target.id.startsWith('auto-mode-')) {
                setTimeout(savePreferences, 100);
            }
        });
        
        // Save triangle position on mouse up
        document.addEventListener('mouseup', () => {
            setTimeout(savePreferences, 100);
        });
        
        document.addEventListener('touchend', () => {
            setTimeout(savePreferences, 100);
        });
        
        // Keyboard Shortcuts
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                analyzeWindsurf();
            }
            if ((e.ctrlKey || e.metaKey) && (e.key === 'h' || e.key === 'H')) {
                e.preventDefault();
                showHistory();
            }
            if ((e.ctrlKey || e.metaKey) && (e.key === 'b' || e.key === 'B')) {
                e.preventDefault();
                showCalculator();
            }
            if ((e.ctrlKey || e.metaKey) && e.key === ',') {
                e.preventDefault();
                showSettings();
            }
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal-overlay.active').forEach(m => m.classList.remove('active'));
            }
            if (e.key === '?') {
                if (document.activeElement.tagName !== 'TEXTAREA' && document.activeElement.tagName !== 'INPUT') {
                    showShortcuts();
                }
            }
        });

        // Close modal on outside click
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.classList.remove('active');
                }
            });
        });

        function showHistory() {
            const modal = document.getElementById('history-modal');
            const list = document.getElementById('history-list');
            modal.classList.add('active');
            
            try {
                const history = JSON.parse(localStorage.getItem('windsurf_history') || '[]');
                if (history.length === 0) {
                    list.innerHTML = '<p class="text-muted text-center" style="text-align: center; color: var(--text-muted);">No history yet.</p>';
                    return;
                }
                
                list.innerHTML = history.map((item, index) => `
                    <div class="history-item" onclick="loadHistoryItem(${index})">
                        <div class="history-header">
                            <span>${new Date(item.timestamp).toLocaleString()}</span>
                            <span>${item.analysis.taskType}</span>
                        </div>
                        <div style="font-size: 0.9rem; margin-bottom: 8px;">
                            ${item.recommendations[0].name} (Score: ${Math.round(item.recommendations[0].score)})
                        </div>
                        <div style="font-size: 0.8rem; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                            complexity: ${item.analysis.complexity}, speed: ${item.analysis.speed}
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                list.innerHTML = '<p style="color: var(--error)">Error loading history</p>';
            }
        }

        function loadHistoryItem(index) {
            try {
                const history = JSON.parse(localStorage.getItem('windsurf_history') || '[]');
                const item = history[index];
                if (item) {
                    STATE.lastAnalysis = item.analysis;
                    STATE.lastRecommendations = item.recommendations; 
                    showToast('History item loaded (Partial)', 'info');
                    closeModal('history-modal');
                }
            } catch (e) {
                showToast('Failed to load item', 'error');
            }
        }

        function showCalculator() {
            document.getElementById('calculator-modal').classList.add('active');
            calculateBudget();
        }

        function calculateBudget() {
            const hours = parseInt(document.getElementById('calc-hours').value);
            const complexity = parseInt(document.getElementById('calc-complexity').value);
            
            document.getElementById('calc-hours-val').textContent = hours + 'h';
            const complexityLabels = ['Very Simple', 'Simple', 'Basic', 'Low', 'Medium', 'Moderate', 'High', 'Heavy', 'Complex', 'Extreme'];
            document.getElementById('calc-complexity-val').textContent = complexityLabels[complexity - 1] || 'Medium';
            
            const tasksPerHour = 4;
            const totalTasks = hours * 20; 
            
            let avgCostPerTask = 0.5;
            if (complexity > 3) avgCostPerTask = 0.8;
            if (complexity > 6) avgCostPerTask = 1.5;
            if (complexity > 8) avgCostPerTask = 2.2;
            
            const totalCost = Math.round(totalTasks * avgCostPerTask);
            const dollarCost = (totalCost / 500) * 15; 
            
            document.getElementById('calc-total').textContent = `${totalCost} Credits`;
            document.getElementById('calc-breakdown').textContent = `~$${dollarCost.toFixed(2)}/mo est.`;
        }

        function showSettings() {
            document.getElementById('settings-modal').classList.add('active');
        }

        function showShortcuts() {
            document.getElementById('shortcuts-modal').classList.add('active');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        function saveCustomModels() {
            try {
                const json = document.getElementById('custom-model-json').value;
                const models = JSON.parse(json);
                localStorage.setItem('windsurf_custom_models', JSON.stringify(models));
                Object.assign(WINDSURF_MODELS, models);
                showToast('Custom models saved & loaded', 'success');
                closeModal('settings-modal');
            } catch (e) {
                showToast('Invalid JSON format', 'error');
            }
        }

        function exportData() {
            const data = {
                preferences: localStorage.getItem('windsurf_preferences'),
                history: localStorage.getItem('windsurf_history'),
                customModels: localStorage.getItem('windsurf_custom_models')
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'windsurf-selector-backup.json';
            a.click();
            URL.revokeObjectURL(url);
            showToast('Data exported', 'success');
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = e => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = event => {
                    try {
                        const data = JSON.parse(event.target.result);
                        if (data.preferences) localStorage.setItem('windsurf_preferences', data.preferences);
                        if (data.history) localStorage.setItem('windsurf_history', data.history);
                        if (data.customModels) localStorage.setItem('windsurf_custom_models', data.customModels);
                        showToast('Data imported successfully. Reloading...', 'success');
                        setTimeout(() => location.reload(), 1500);
                    } catch (err) {
                        showToast('Failed to import data', 'error');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function clearAllData() {
            if (confirm('Are you sure you want to delete all history and settings?')) {
                localStorage.clear();
                location.reload();
            }
        }

        // Keyboard Shortcuts
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                analyzeWindsurf();
            }
            if ((e.ctrlKey || e.metaKey) && (e.key === 'h' || e.key === 'H')) {
                e.preventDefault();
                showHistory();
            }
            if ((e.ctrlKey || e.metaKey) && (e.key === 'b' || e.key === 'B')) {
                e.preventDefault();
                showCalculator();
            }
            if ((e.ctrlKey || e.metaKey) && e.key === ',') {
                e.preventDefault();
                showSettings();
            }
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal-overlay.active').forEach(m => m.classList.remove('active'));
            }
            if (e.key === '?') {
                if (document.activeElement.tagName !== 'TEXTAREA' && document.activeElement.tagName !== 'INPUT') {
                    showShortcuts();
                }
            }
        });

        // Close modal on outside click
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.classList.remove('active');
                }
            });
        });

    </script>
</body>
</html>